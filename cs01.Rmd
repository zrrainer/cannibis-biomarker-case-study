---
title: "CS01: Biomarkers of Recent Use"
author: "Derek, Eddie, Rainer"
output: 
  html_document:
    toc: true
    toc_float: true
---

## Introduction

For our case study, the primary focus is to figure out which compound is the best biomarker for recent use while also deciphering which matrix is most optimal as well. In further detail, the compound, which could be THC, CBN, etc., falls within one of three matrices of the following: blood, breath, and oral fluid. Within the time frame of three hours or 180 minutes, we would like to figure out which compound and it's respective matrix is the most potent so that we could extrapolate our findings to real life applications. The reason as to why this study is important is because accurately testing for marijuana usage is very important in different everyday scenarios. For example, THC in marijuana can affect an individuals motor skills, depth perception, and overall cognition. This then can hinder their ability to work effectively and safely. According to the National Institute on Drug Abuse, it is noted that employees that tested positive for marijuana had an increase of 55% when it came to workplace accidents and that they were responsible for another increase of 85% of work-related injuries [^1]. These liabilities can hurt the company and more importantly, the individual; hence why it is paramount for companies to run effective drug tests on their employees. Another example why finding out which compound and matrix is most effective to use when conducting a drug test is for scenarios in which we'd like to find out if a driver is under the influence or not. Quoted directly from the National Highway Traffic Safety Administration, "In the 2013-2014 survey [^2], 12.6 percent of weekend nighttime drivers tested positive for marijuana. That's a 48-percent increase in less than 10 years" [^3].

[^1]:
    (2023) Marijuana at Work: What Employers Need to Know. NSC. <https://www.nsc.org/nsc-membership/marijuana-at-work#>:\~:text=According%20to%20a%20study%20reported,Decreased%20productivity

[^2]: Research Note: Results of the 2013-2014 National Roadside Survey of Alcohol and Drug Use by Drivers. NHTSA. <https://www.nhtsa.gov/sites/nhtsa.gov/files/812118-roadside_survey_2014.pdf>

[^3]: Drug-Impaired Driving. NHTSA. <https://www.nhtsa.gov/risky-driving/drug-impaired-driving#>:\~:text=In%202007%2C%20NHTSA's%20National%20Roadside,in%20less%20than%2010%20years.

All of this information is quite alarming and that is why we want to figure out which compound and matrix is the most effective to analyze when trying to figure out if an individual is under the influence or not. It is also worth mentioning that we'd like to go deeper with this study by also trying to find out if some of these compounds are more sensitive to higher or lower doses of marijuana. The relationship between these variables can provide us with substantial information in regards to figuring out if some compounds are worth paying more attention to than others. This ultimately saves the tester a lot of time when they're running a drug test on an individual.

```{r setup, include=FALSE}

# control global Rmd chunk settings
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)

source("src/functions.R")
source("src/sen&spe.R")
source("src/ROC.R")
source("src/cutoff.R")

```

### Load packages

```{r load-packages, message=FALSE}

library(tidymodels)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(janitor)
library(purrr)
library(rstatix)
library(cowplot)

```

## Question

-   Which compound, in which matrix, and at what cutoff is the best biomarker of recent use? (recent use is defined as 3h)
-   "do some compound respond more to high dose/low dose compared to the other?"

## The Data

### Data Import

```{r importing-data}

WB = read.csv("data/Blood.csv")
BR = read.csv("data/Breath.csv")
OF = read.csv("data/OF.csv")

```

### Data Wrangling

We re-coded and re-leveled variables (`Treatment` and `Group`), cleans column names, and renames specific columns (`x11_oh_thc` to `thcoh`, `thc_v` to `thcv`, `thccooh_gluc` to `thc_cooh_gluc`, and `thccooh` to `thc_cooh`) in all 3 tables. Using `janitor` package to organized column names.

\*\*Suggestion: add a new column recording whether someone should be determined to have recent THC use (THC group, within 3 hr of smoking) or not(all placebo group, or THC group outside the 3hr window)

```{r re-leveling-data}

OF <- OF |>
  mutate(Treatment = fct_recode(Treatment, 
                                "5.9% THC (low dose)" = "5.90%",
                                "13.4% THC (high dose)" = "13.40%"),
         Treatment = fct_relevel(Treatment, "Placebo", "5.9% THC (low dose)"),
         Group = fct_recode(Group, 
                            "Occasional user" = "Not experienced user",
                            "Frequent user" = "Experienced user" )) |>  
  janitor::clean_names() |>
  rename(thcoh = x11_oh_thc,
         thcv = thc_v)

WB <- WB |> 
  mutate(Treatment = fct_recode(Treatment, 
                                "5.9% THC (low dose)" = "5.90%",
                                "13.4% THC (high dose)" = "13.40%"),
         Treatment = fct_relevel(Treatment, "Placebo", "5.9% THC (low dose)")) |> 
  janitor::clean_names() |>
  rename(fluid = fluid_type,
         thcoh = x11_oh_thc,
         thccooh = thc_cooh,
         thccooh_gluc = thc_cooh_gluc,
         thcv = thc_v)

BR <- BR |> 
  mutate(Treatment = fct_recode(Treatment, 
                                "5.9% THC (low dose)" = "5.90%",
                                "13.4% THC (high dose)" = "13.40%"),
         Treatment = fct_relevel(Treatment, "Placebo", "5.9% THC (low dose)"),
         Group = fct_recode(Group, 
                            "Occasional user" = "Not experienced user",
                            "Frequent user" = "Experienced user" )) |> 
  janitor::clean_names() |> 
  rename(thc = thc_pg_pad)


compounds_WB <-  as.list(colnames(Filter(function(x) !all(is.na(x)), WB[6:13])))
compounds_BR <-  as.list(colnames(Filter(function(x) !all(is.na(x)), BR[6])))
compounds_OF <-  as.list(colnames(Filter(function(x) !all(is.na(x)), OF[6:12])))
```

Created 3 tables based on specific minutes and labeled accordingly, covering pre-smoking and subsequent post-smoking time periods for blood, breath, and oral fluid data.

```{r table-creation}

timepoints_WB <- tibble(
  start = c(-400, 0, 30, 70, 100, 180, 210, 240, 270, 300),
  stop = c(
    0,
    30,
    70,
    100,
    180,
    210,
    240,
    270,
    300,
    max(WB$time_from_start, na.rm = TRUE)
  ),
  timepoint = c(
    "pre-smoking",
    "0-30 min",
    "31-70 min",
    "71-100 min",
    "101-180 min",
    "181-210 min",
    "211-240 min",
    "241-270 min",
    "271-300 min",
    "301+ min"
  )
)

timepoints_BR <- tibble(
  start = c(-400, 0, 40, 90, 180, 210, 240, 270),
  stop = c(
    0,
    40,
    90,
    180,
    210,
    240,
    270,
    max(BR$time_from_start, na.rm = TRUE)
  ),
  timepoint = c(
    "pre-smoking",
    "0-40 min",
    "41-90 min",
    "91-180 min",
    "181-210 min",
    "211-240 min",
    "241-270 min",
    "271+ min"
  )
)

timepoints_OF <- tibble(
  start = c(-400, 0, 30, 90, 180, 210, 240, 270),
  stop = c(0, 30, 90, 180, 210, 240, 270,
           max(OF$time_from_start, na.rm = TRUE)),
  timepoint = c(
    "pre-smoking",
    "0-30 min",
    "31-90 min",
    "91-180 min",
    "181-210 min",
    "211-240 min",
    "241-270 min",
    "271+ min"
  )
)

assign_timepoint <- function(x, timepoints) {
  if (!is.na(x)) {
    timepoints$timepoint[x > timepoints$start & x <= timepoints$stop]
  } else{
    NA
  }
}
```

We created a new column, **`timepoint_use`**, in each table by mapping the **`time_from_start`** values to specific timepoints defined in separate reference data frames (**`timepoints_WB`**, **`timepoints_OF`**, **`timepoints_BR`**). Finally, re-leveled the **`timepoint_use`** factor variable to align with the order specified in the reference data frames. This ensures consistent and meaningful timepoint labels for subsequent analyses or visualizations in the study.

```{r}

 WB <- WB |> 
  mutate(timepoint_use = map_chr(time_from_start, 
                                 assign_timepoint, 
                                 timepoints=timepoints_WB),
         timepoint_use = fct_relevel(timepoint_use, timepoints_WB$timepoint))

OF <- OF |> 
  mutate(timepoint_use = map_chr(time_from_start, 
                                 assign_timepoint, 
                                 timepoints=timepoints_OF),
         timepoint_use = fct_relevel(timepoint_use, timepoints_OF$timepoint))

BR <- BR |> 
  mutate(timepoint_use = map_chr(time_from_start, 
                                 assign_timepoint, 
                                 timepoints=timepoints_BR),
         timepoint_use = fct_relevel(timepoint_use, timepoints_BR$timepoint))

```

remove duplicate id

```{r}

WB <- drop_dups(WB)
OF <- drop_dups(OF)
BR <- drop_dups(BR)

```

## Analysis

### Exploratory Data Analysis

#### compounds measurements over time by treatment

The following plots include of all compounds against time, distinguished by color according to their respective groups. To achieve a comprehensive understanding, we generated scatterplots for compounds across three distinct matrices---namely, whole blood, oral fluid, and breath. This analysis encompasses various timepoints and considers different treatments, namely, placebo, low dose, and high dose.

Upon close examination of the scatterplots, a noteworthy observation emerges, particularly concerning the **THC** biomarker in whole blood. This specific biomarker appears to offer a potentially enhanced indication of recent cannabis joint usage. The scatterplot reveals a discernible separation between the **placebo** and **THC** treatment groups, suggesting that the **THC** measurement in whole blood may serve as a more reliable indicator of recent cannabis joint consumption.

```{r}
scatter_WB <- map(compounds_WB, ~ compound_scatterplot_group_by_treatment( 
    dataset=WB, 
    compound=.x, 
    timepoints=timepoints_WB))

scatter_OF <- map(compounds_OF, ~ compound_scatterplot_group_by_treatment( 
    dataset=OF, 
    compound=.x, 
    timepoints=timepoints_OF))

scatter_BR <- map(compounds_BR, ~ compound_scatterplot_group_by_treatment( 
    dataset=BR, 
    compound=.x, 
    timepoints=timepoints_BR))
```

In the presented set of scatterplots, all compounds are graphically depicted against time, with color distinctions denoting different treatment conditions and a log transformation applied to the y-axis, which represents the respective compound measurements. A comparative analysis with the previous scatterplots reveals a modification: specifically, a log transformation has been applied to the y-axis, providing an alternative perspective on the measurement of the compounds.

Upon closer examination, a notable observation emerges. The measurement of **THC** from breath exhibits a more discernible separation between the **placebo** and **THC** treatment groups in the log-transformed scatterplots. This suggests that the log transformation on the y-axis enhances the visibility of distinctions between the treatment conditions for **THC**. The log transformation, by compressing the scale, may unveil nuances and patterns that are not as apparent on a linear scale. This nuanced insight into **THC** measurements underscores the importance of considering the impact of transformation techniques when analyzing compound data over time in the context of different treatments. The enhanced separation observed in the log-transformed scatterplots could potentially provide valuable insights into the effects of treatments on **THC** levels and underscores the sensitivity of the chosen visualization approach.

```{r, cache = TRUE}
scatter_WB_by_treatment <- map(compounds_WB, ~ compound_scatterplot_group_by_treatment_log( 
    dataset=WB, 
    compound=.x, 
    timepoints=timepoints_WB))

scatter_OF_by_treatment <- map(compounds_OF, ~ compound_scatterplot_group_by_treatment_log( 
    dataset=OF, 
    compound=.x, 
    timepoints=timepoints_OF))

scatter_BR_by_treatment <- map(compounds_BR, ~ compound_scatterplot_group_by_treatment_log( 
    dataset=BR, 
    compound=.x, 
    timepoints=timepoints_BR))
```

Calculating sensitivity and specificity.

```{r, cache=TRUE}
output_WB <- map_dfr(compounds_WB,
                     ~ sens_spec_cpd(
                       dataset = WB,
                       cpd = all_of(.x),
                       timepoints =  timepoints_WB
                     )) |> clean_gluc()

output_BR <- map_dfr(compounds_BR,
                     ~ sens_spec_cpd(
                       dataset = BR,
                       cpd = all_of(.x),
                       timepoints = timepoints_BR
                     ))  |> clean_gluc()

output_OF <- map_dfr(compounds_OF,
                     ~ sens_spec_cpd(
                       dataset = OF,
                       cpd = all_of(.x),
                       timepoints = timepoints_OF
                     ))  |> clean_gluc()
```

#### cutoff vs. sensitivity/specificity

Here we plot the value of the cutoff against sensitivity and specificity for every compound in every matrix, and arrange them all into one big plot. This is also known as the ROC curve of sensitivity and specificity against cutoff values suggests an exploration of optimal cutoff points. Overall, the specificity of all compounds increases when detection limit rises. On the other hand, sensitivity drops to zero when detection limit rises.

```{r, cache=TRUE, include=FALSE}
#plot detection limit(cutoff) vs. sensitivity and specificity
ss_WB <-
  ss_plot(output_WB, tpts = length(unique(output_WB$time_start)), tissue = "Blood")
ss_OF <-
  ss_plot(output_OF, tpts = length(unique(output_OF$time_start)), tissue = "Oral Fluid")
ss_BR <-
  ss_plot(output_BR, tpts = length(unique(output_BR$time_start)), tissue = "Breath")
```

```{r fig.height=7, fig.width=15}
#arranges ss plots into one
ss_bottom_row <-
  plot_grid(
    ss_OF,
    ss_BR,
    labels = c('B', 'C'),
    label_size = 12,
    ncol = 2,
    rel_widths = c(0.66, .33)
  )
plot_grid(
  ss_WB,
  ss_bottom_row,
  labels = c('A', ''),
  label_size = 12,
  ncol = 1
)

```

#### sensitivity vs. specificity

In this visual representation, we graph the sensitivity against specificity for each compound within every matrix, consolidating the data into a comprehensive plot. This collective visualization allows for a convenient comparison of the performance of various biomarkers concerning their specificity and sensitivity.

The plot serves as a valuable tool for discerning the intricate balance between specificity and sensitivity exhibited by different compounds. While numerous compounds demonstrate an ability to achieve a specificity of 100, it's essential to acknowledge the inherent trade-off with sensitivity. In-depth analysis of this plot becomes instrumental in the decision-making process, guiding us to identify the optimal biomarker for recent use based on factors such as the compound itself, the matrix in which it is observed, and the specific cutoff value applied.

```{r include=FALSE}
#plot sensitivity vs. specificity
roc_WB = roc_plot(output_WB, tpts = length(unique(output_WB$time_start)), tissue = "Blood")
roc_OF = roc_plot(output_OF, tpts = length(unique(output_OF$time_start)), tissue = "Oral Fluid")
roc_BR = roc_plot(output_BR, tpts = length(unique(output_BR$time_start)), tissue = "Breath")
```

```{r fig.height=7, fig.width=15}
#arrange roc plots
roc_bottom_row <-
  plot_grid(
    roc_OF,
    roc_BR,
    labels = c('B', 'C'),
    label_size = 12,
    ncol = 2,
    rel_widths = c(0.66, .33)
  )
plot_grid(
  roc_WB,
  roc_bottom_row,
  labels = c('A', ''),
  label_size = 12,
  ncol = 1
)
```

#### plot sensitivity and specificity over time given specific cutoffs

Taking a deeper dive into sensitivity and specificity over time over time for the measurement of `THC` in **Blood** and **Oral Fluid** tissues. In direct comparison between the two measurement methods of `THC`, it becomes evident that **Oral Fluid** outshines its counterpart in terms of both sensitivity and specificity, particularly within the critical time span of three hours post-smoking.

```{r}
#pass specific cutoff into splits parameter
WB_THC <- sens_spec_cpd(
  dataset = WB,
  cpd = 'thc',
  timepoints = timepoints_WB,
  splits =  c(0.5, 1, 2, 5, 10)
) |> clean_gluc()

OF_CBG <- sens_spec_cpd(
  dataset = OF,
  cpd = 'thc',
  timepoints = timepoints_OF,
  splits =  c(0.5, 1, 2, 5, 10)
) |> clean_gluc()
```

```{r fig.width=13}
blood_levels <- c("pre-smoking\nN=189", "0-30\nmin\nN=187", "31-70\nmin\nN=165",
                  "71-100\nmin\nN=157", "101-180\nmin\nN=168", "181-210\nmin\nN=103",
                  "211-240\nmin\nN=127", "241-270\nmin\nN=137", "271-300\nmin\nN=120",
                  "301+\nmin\nN=88")
of_levels <- c("pre-smoking\nN=192", "0-30\nmin\nN=192", "31-90\nmin\nN=117",
               "91-180\nmin\nN=99", "181-210\nmin\nN=102", "211-240\nmin\nN=83",
               "241-270\nmin\nN=90",  "271+\nmin\nN=76")

plot_cutoffs(
  dataset = WB_THC,
  timepoint_use_variable = WB$timepoint_use,
  tissue = "Blood",
  cpd = "THC",
  x_labels = blood_levels
)[1]

plot_cutoffs(
  dataset = OF_CBG,
  timepoint_use_variable = OF$timepoint_use,
  tissue = "Oral Fluid",
  cpd = "THC",
  x_labels = of_levels
)[1]
```

### extended question

#### wrangling

```{r}
WB_long = WB |>
  pivot_longer(6:13, names_to = "compound")

OF_long = OF |>
  pivot_longer(6:12, names_to = "compound")

BR_long <- BR |> pivot_longer(6)

df_full <- bind_rows(WB_long, OF_long, BR_long)
```

#### Part 1: so uh the "placebo groups might have different compound measurements" hypothesis has been disproven :(

This one is me testing out an extended question our group proposed: does taking a placebo have an effect on any of the compound?

Theoretically, no, it shouldn't. But the graph about subjective highness being basically random really peaked my interest and I thought there might be something worth looking into. But the data disproves that theory :(

```{r}
WB_long |>
  filter(treatment == "Placebo") |>
  filter(timepoint_use == "pre-smoking" |
         timepoint_use == "0-30 min") |>
  ggplot(mapping = aes(x = log(value))) +
  geom_histogram(binwidth = 0.5) +
  facet_grid(vars(timepoint_use), vars(compound), scales = "free")
```

#### part 2: BUT i have a different extended question we can look into

This one is SUPER interesting. Some of the pairplots we went over in lecture notes 12 looked like they has two separate lines, so I thought one of the variables might change how compounds correlate with each other - and they do! Namely, the low dose and high dose group seems to have different slopes when it comes to the correlation between certain compounds.

Here's a few of the more obvious ones:

```{r fig.width=9}
ggplot(data = WB,
       aes(y = cbg, x = thc, color = treatment)) +
  geom_point(alpha = 0.5) +
  facet_wrap(~ group, scales = "free")

ggplot(data = OF,
       aes(y = thc, x = cbg, color = treatment)) +
  geom_point(alpha = 0.5) +
  facet_wrap( ~ group, scales = "free")

ggplot(data = OF,
       aes(y = cbn, x = cbg, color = treatment)) +
  geom_point(alpha = 0.5) +
  facet_wrap( ~ group, scales = "free")

ggplot(data = OF,
       aes(y = cbg, x = thcv, color = treatment)) +
  geom_point(alpha = 0.5) +
  facet_wrap( ~ group, scales = "free")
```

this seems to show that even though low dose/high dose doesn't effect chemical concentration overall (as shown in the plots in lecture notes), they do change the correlation between chemicals. Maybe a potential extended question would be "do some compound respond more to high dose/low dose compared to the other?"

### Data Analysis

Taking a deeper dive into sensitivity and specificity over time over time for the measurement of `THC` in **Blood** and **Oral Fluid** tissues. In direct comparison between the two measurement methods of `THC`, it becomes evident that **Oral Fluid** outshines its counterpart in terms of both sensitivity and specificity, particularly within the critical time span of three hours post-smoking.

```{r}
#pass specific cutoff into splits parameter
WB_THC <- sens_spec_cpd(
  dataset = WB,
  cpd = 'thc',
  timepoints = timepoints_WB,
  splits =  c(0.5, 1, 2, 5, 10)
) |> clean_gluc()

OF_CBG <- sens_spec_cpd(
  dataset = OF,
  cpd = 'thc',
  timepoints = timepoints_OF,
  splits =  c(0.5, 1, 2, 5, 10)
) |> clean_gluc()
```

```{r}
plot_cutoffs(
  dataset = WB_THC,
  timepoint_use_variable = WB$timepoint_use,
  tissue = "Blood",
  cpd = "THC",
  x_labels = blood_levels
)[1]

plot_cutoffs(
  dataset = OF_CBG,
  timepoint_use_variable = OF$timepoint_use,
  tissue = "Oral Fluid",
  cpd = "THC",
  x_labels = of_levels
)[1]
```

```{r}
ggplot(data = WB,
       aes(y = cbg, x = thc, color = treatment)) +
  geom_point(alpha = 0.5) +
  geom_smooth(
    method = "lm",
    # Use linear regression
    formula = y ~ x,
    # Specify the formula for the linear model
    se = FALSE,
    # Don't show the confidence interval
    data = WB |> filter(treatment == "5.9% THC (low dose)"),
    # Filter for low dose
    color = "green"
  ) +
  geom_smooth(
    method = "lm",
    formula = y ~ x,
    se = FALSE,
    data = WB |> filter(treatment == "13.4% THC (high dose)"),
    # Filter for high dose
    color = "blue"
  ) +
  facet_wrap(~ group, scales = "free")

ggplot(data = OF,
       aes(y = thc, x = cbg, color = treatment)) +
  geom_point(alpha = 0.5) +
  geom_smooth(
    method = "lm",
    formula = y ~ x,
    se = FALSE,
    data = OF |> filter(treatment == "5.9% THC (low dose)"),
    color = "green"
  ) +
  geom_smooth(
    method = "lm",
    formula = y ~ x,
    se = FALSE,
    data = OF |> filter(treatment == "13.4% THC (high dose)"),
    color = "blue"
  ) +
  facet_wrap( ~ group, scales = "free")

ggplot(data = OF,
       aes(y = cbn, x = cbg, color = treatment)) +
  geom_point(alpha = 0.5) +
  geom_smooth(
    method = "lm",
    formula = y ~ x,
    se = FALSE,
    data = OF |> filter(treatment == "5.9% THC (low dose)"),
    color = "green"
  ) +
  geom_smooth(
    method = "lm",
    formula = y ~ x,
    se = FALSE,
    data = OF |> filter(treatment == "13.4% THC (high dose)"),
    color = "blue"
  ) +
  facet_wrap( ~ group, scales = "free")

ggplot(data = OF,
       aes(y = cbg, x = thcv, color = treatment)) +
  geom_point(alpha = 0.5) +
  geom_smooth(
    method = "lm",
    formula = y ~ x,
    se = FALSE,
    data = OF |> filter(treatment == "5.9% THC (low dose)"),
    color = "green"
  ) +
  geom_smooth(
    method = "lm",
    formula = y ~ x,
    se = FALSE,
    data = OF |> filter(treatment == "13.4% THC (high dose)"),
    color = "blue"
  ) +
  facet_wrap( ~ group, scales = "free")
```

In the visualization, we systematically analyzed each compound's correlation patterns under low and high doses to discern whether particular compounds showcase distinct responses to dosage variations. We fit 2 linear models on low dose group and high dose group respectivly. Quantifying the degree of change in correlation coefficients for each compound under different dosage conditions. This approach could provide insights into the magnitude of variations in compound interactions.

### Results

### Discussion

## Conclusion
